# AI分析：扩展市场数据传递

## 概述
在请求大模型分析趋势和交易策略时，现在会传递完整的国内白银市场数据，包括盘口数据和21个扩展字段。

## 传递给AI的数据结构

### 1. 买卖盘口数据
```
卖5: 价格 11318, 数量 33
卖4: 价格 11317, 数量 19
卖3: 价格 11316, 数量 57
卖2: 价格 11315, 数量 5
卖1: 价格 11314, 数量 43

买1: 价格 11313, 数量 2
买2: 价格 11312, 数量 22
买3: 价格 11311, 数量 34
买4: 价格 11310, 数量 56
买5: 价格 11309, 数量 19
```

### 2. 实时市场数据（新增）

#### 价格信息
- 最新价、开盘价、最高价、最低价、均价

#### 涨跌信息
- 涨跌金额、涨跌幅、昨结算价

#### 成交和持仓信息
- 成交量（手）
- 成交额（自动格式化为万/亿）
- 持仓量及变化（包含增减数量和百分比）
- 昨持仓量

#### 合约信息
- 合约名称（如：沪银主连）
- 合约乘数（kg/手）
- 涨停价、跌停价

## 数据示例

```markdown
=== 国内白银实时盘口数据 ===

**卖盘（卖5到卖1）**：
  卖5: 价格 11318, 数量 33
  卖4: 价格 11317, 数量 19
  卖3: 价格 11316, 数量 57
  卖2: 价格 11315, 数量 5
  卖1: 价格 11314, 数量 43

**买盘（买1到买5）**：
  买1: 价格 11313, 数量 2
  买2: 价格 11312, 数量 22
  买3: 价格 11311, 数量 34
  买4: 价格 11310, 数量 56
  买5: 价格 11309, 数量 19

**实时市场数据**：
- 最新价: 11314  开盘: 11297  最高: 11388  最低: 11255  均价: 11331
- 涨跌: +110 (+0.98%)  昨结算: 11204
- 成交量: 420,517手  成交额: 714.74亿元
- 持仓量: 244,852手 (+578, +0.24%)  昨持仓: 244,274手
- 合约: 沪银主连  乘数: 15kg/手
- 涨停: 12772  跌停: 9635

**盘口分析要点**：
- 买卖价差：反映市场流动性和交易活跃度
- 买卖盘量比：反映多空力量对比
- 持仓量变化：增仓说明市场参与度提升，减仓说明资金流出
- 成交量和成交额：反映市场活跃程度
- 涨跌幅和相对位置：当前价格在日内高低点的位置
```

## AI分析优势

通过传递这些扩展数据，AI可以：

### 1. 资金流向分析
- **成交量和成交额**：判断市场活跃度
- **持仓量变化**：识别多空力量对比
  - 增仓 = 新资金进场
  - 减仓 = 资金流出

### 2. 市场情绪判断
- **涨跌幅**：当前市场的多空倾向
- **相对位置**：价格在日内高低点的位置
  - 接近最高 = 偏强势
  - 接近最低 = 偏弱势

### 3. 风险控制
- **涨跌停价**：极端风险边界
- **买卖盘对比**：即时流动性状况
- **价格波动幅度**：当日波动率

### 4. 趋势强度评估
- **持仓量与价格关系**：
  - 价格上涨 + 持仓增加 = 强势上涨
  - 价格上涨 + 持仓减少 = 弱势反弹
  - 价格下跌 + 持仓增加 = 强势下跌
  - 价格下跌 + 持仓减少 = 弱势回调

### 5. 合约特性考虑
- **合约乘数**：计算实际价值
- **最小变动单位**：价格精度
- **涨跌停限制**：当日最大波动空间

## 代码位置

**文件**：`frontend/script.js`

**函数**：`callAnalysisAPI()`

**位置**：第5226-5320行

## 使用方法

1. 确保盘口数据正常更新（每1秒刷新）
2. 点击"AI走势分析"按钮
3. AI会自动获取最新的扩展市场数据
4. 分析结果会考虑这些市场数据

## 数据更新频率

- **盘口数据**：每1秒更新一次
- **扩展数据**：与盘口数据同步更新
- **AI分析**：手动触发或自动定时触发

## 数据质量保证

1. **非空检查**：所有字段都有默认值处理
2. **类型转换**：自动处理字符串和数字转换
3. **格式化**：成交额、持仓量等自动格式化
4. **容错处理**：字段缺失时不影响其他数据

## 预期效果

AI分析将更加：
- 🎯 **精准**：基于实时市场数据而非仅K线
- 📊 **全面**：考虑资金流、持仓量、成交量等多维度
- ⚡ **实时**：反映当前市场情绪和动态
- 🛡️ **稳健**：结合涨跌停、持仓变化等风控因素

## 测试验证

在浏览器控制台查看日志：
```javascript
[callAnalysisAPI] 已添加国内白银实时盘口数据和扩展市场数据到messages
```

查看完整的prompt内容：
```javascript
console.log(messages[messages.length - 2].content)
```

## 更新日志

**2025-11-06**
- 添加21个扩展市场数据字段到AI分析prompt
- 优化数据格式化和展示
- 添加盘口分析要点说明
- 更新AI分析指令，强调市场数据的重要性

