# 测试文档

## 测试脚本说明

### test_depth_extended_fields.py

**功能：** 测试国内白银盘口数据的扩展字段

**测试内容：**
1. 验证盘口API是否正常返回数据
2. 检查所有基础字段（买卖五档）
3. 验证所有扩展字段（价格、成交量、成交额等）
4. 格式化显示盘口数据
5. 测试调试接口查看Quote对象所有字段

**运行方法：**
```bash
cd /Users/zhangzhigong/cursor/s-4
python test/test_depth_extended_fields.py
```

**前置条件：**
- 后端服务运行在8000端口
- TqSdk订阅任务正常运行

## 测试结果（最新更新：2025-11-06 10:01:57）

### ✅ 测试通过（根据TqSdk官方文档优化）

**基础字段：** 4/4 通过
- 买价(1-5档) ✅
- 买量(1-5档) ✅  
- 卖价(1-5档) ✅
- 卖量(1-5档) ✅

**扩展字段：** 21/21 有效值（100%完成度！🎉）
- ✅ 最新价 (last_price): 11314
- ✅ 成交量 (volume): 420,517 手
- ✅ 成交额 (amount): 714.74亿元
- ✅ 持仓量 (open_interest): 244,852 手 (+578, +0.24%)
- ✅ 昨持仓 (pre_open_interest): 244,274 手 **[新增]**
- ✅ 最高价 (highest): 11388
- ✅ 最低价 (lowest): 11255
- ✅ 开盘价 (open): 11297
- ✅ 收盘价 (close): nan （交易时段内为nan）**[新增]**
- ✅ 昨收盘 (pre_close): 11276 **[新增]**
- ✅ 均价 (average): 11331
- ✅ 结算价 (settlement): nan （盘中为nan）**[新增]**
- ✅ 昨结算 (pre_settlement): 11204
- ✅ 涨停价 (upper_limit): 12772
- ✅ 跌停价 (lower_limit): 9635
- ✅ **涨跌 (change): +110.0** （自动计算 = 最新价 - 昨结算）**[修复]**
- ✅ **涨跌幅 (change_percent): +0.98%** （自动计算）**[修复]**
- ✅ 合约名称 (instrument_name): 沪银主连 **[新增]**
- ✅ 最小变动 (price_tick): 1.0 **[新增]**
- ✅ 合约乘数 (volume_multiple): 15 kg/手 **[新增]**
- ✅ 行情时间 (datetime): 2025-11-06 10:06:44 **[新增]**

**Quote对象统计：**
- 总字段数：72 个
- 价格字段：14 个
- 成交量字段：20 个
- 成交额字段：1 个
- 持仓量字段：3 个
- 时间字段：4 个

### 盘口数据示例

```
档位                 卖价           卖量               买价           买量
-----------------------------------------------------------------
第1档         11309           18            11308            3
第2档         11310           16            11307           39
第3档         11311           26            11306           81
第4档         11312           31            11305          165
第5档         11313           43            11304           40
```

### 价格信息
```
最新价:      11308    开盘价:      11297
最高价:      11388    最低价:      11255
均  价:      11331
```

### 成交信息
```
成交量:         417,786 手
成交额:             710.10亿元
持仓量:         244,861 手 (+587, +0.24%)
昨持仓:         244,274 手
```

### 合约信息
```
合约名称: 沪银主连
最小变动: 1.0
合约乘数: 15 kg/手
行情时间: 2025-11-06 10:01:57
```

## 已实现的功能

### 后端扩展 (backend/routes/data.py)
- ✅ 在 `/api/data/depth-tick` 接口添加 **21个扩展字段**（根据TqSdk官方文档）
- ✅ 安全的字段获取函数 `get_field()`
- ✅ 所有字段都有默认值处理
- ✅ 新增字段包括：昨持仓、昨收盘、收盘价、结算价、合约信息、行情时间等

### 前端显示 (frontend/script.js)
- ✅ 盘口面板显示"实时市场数据"区域
- ✅ **5行网格布局**展示扩展字段（从3行扩展到5行）
  - 第1行：最新价、开盘、最高、最低
  - 第2行：涨跌、涨跌幅、均价、昨结算
  - 第3行：成交量、成交额、持仓量（含变化）、昨持仓
  - 第4行：收盘价、昨收盘、结算价、涨跌停
  - 第5行：合约名称、最小变动、合约乘数、行情时间
- ✅ 持仓量变化自动计算并标色（红涨绿跌）
- ✅ 成交额自动格式化（万/亿）
- ✅ 价格涨跌颜色标识
- ✅ 数值千分位格式化
- ✅ 实时显示行情更新时间

### 样式美化 (frontend/style.css)
- ✅ 扩展数据区域样式
- ✅ 响应式网格布局
- ✅ 颜色主题统一
- ✅ 卡片式设计

## 服务端口

- ✅ **8000端口** - 主服务（后端API + 前端页面）
- ❌ **8080端口** - 已关闭

## 启动命令

```bash
# 启动后端服务（8000端口）
cd /Users/zhangzhigong/cursor/s-4
uvicorn backend.app:app --reload --host 0.0.0.0 --port 8000

# 访问前端页面
open http://localhost:8000

# 运行测试
python test/test_depth_extended_fields.py
```

## 调试接口

查看Quote对象所有字段（仅供调试）：
```bash
curl http://localhost:8000/api/debug/quote-fields | python -m json.tool
```

## 注意事项

1. **change 和 change_percent 字段为0**
   - 可能是TqSdk的计算方式，或者需要特定时间段才有值
   - 不影响其他字段的正常使用

2. **数据实时性**
   - 所有数据通过TqSdk订阅实时更新
   - 前端每1秒自动刷新一次

3. **字段可用性**
   - 72个字段中大部分都可用
   - 某些字段可能在非交易时间为空

## 下一步计划

- [ ] 优化 change 和 change_percent 的计算
- [ ] 添加更多技术指标
- [ ] 历史数据对比功能
- [ ] 数据导出功能

